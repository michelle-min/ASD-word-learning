<!DOCTYPE html>
<html>
  <head>
    <title> Polysemy Experiment </title>
    <script src="js/jspsych/jspsych.js"></script>
    <script src="js/jspsych/plugins/jspsych-fullscreen.js"></script>
    <script src="js/jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="js/jspsych/plugins/jspsych-audio-button-response.js"></script>
    <script src="js/jspsych/plugins/jspsych-video-keyboard-response.js"></script>
    <script src="js/jspsych/plugins/jspsych-free-sort.js"></script>
    <script src="js/polysemy_info.js"></script>
    <script src="js/pal_info.js"></script>
    <link href="js/jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <style>
      .grid-container {
        display: grid;
        grid-template-columns: 1;
        grid-template-rows: 1;
      }
      .grid-container > div {
        margin: 40px;
      }
    </style>
  </head>
  <body></body>
  <script>

  var timeline = [];

/* 1. Polysemy Task: intro block */

  /* Create timeline variable of target, 3 distractors, and audio for 8 trials;
  shuffle choice order within each trial; record block info for analysis.
  note: delete two distractors from loop for a 2-choice experiment */
  var intro_stimuli = [];
  for (i = 0; i < introTargets.length; i++) {
    introChoices = [introImages[4*i], introImages[4*i+1], introImages[4*i+2], introImages[4*i+3]];
    introChoices = jsPsych.randomization.shuffle(introChoices);
    intro_stimuli[i] = {choices: introChoices, audio: introAudio[i], target: introTargets[i], block: 'intro'}, + "\n";
  }

  /* HTML for all image buttons */
  var stimButton = '<div class="grid-container"><div><img src="%choice%" width="250" height="250"/></div></div>';

  /* Audio-button trial for polysemy task */
  var polysemy_audiobutton = {
      type: 'audio-button-response',
      stimulus: jsPsych.timelineVariable('audio'),
      choices: jsPsych.timelineVariable('choices'),
      button_html: stimButton,
      data: {
        choices: jsPsych.timelineVariable('choices'),
        audio: jsPsych.timelineVariable('audio'),
        target: jsPsych.timelineVariable('target'),
        block: jsPsych.timelineVariable('block'),
        task: 'polysemy'
      },
      on_finish: function(data){
        var acc = false;
        var indexNumber = data.button_pressed;
        if (data.target == data.choices[indexNumber]) {
          acc = true
        }
        data.accuracy = acc;
      }
  };

  /* Procedure for an intro block that shuffles trial order */
  var intro_procedure = {
    timeline: [polysemy_audiobutton],
    timeline_variables: intro_stimuli,
    randomize_order: true
  };

/* 2. Polysemy Task: test block */

  /* Shuffle list of distractors (from polysemy_info.js) */
  var testDistractors = jsPsych.randomization.shuffle(testDistractors);

  /* Create timeline variable of target, 3 distractors, and audio for 18 trials;
  shuffle choice order within each trial; record info for later.
  note: delete two distractors from loop for a 2-choice experiment */
  var test_stimuli = [];
  for (i = 0; i < testTargets.length; i++) {
    testChoices = [testTargets[i], testDistractors[3*i], testDistractors[3*i+1], testDistractors[3*i+2]];
    testChoices = jsPsych.randomization.shuffle(testChoices);
    test_stimuli[i] = {choices: testChoices, audio: testAudio[i], target: testTargets[i], block: 'test'}, + "\n";
  }

  /* FILLERS: Intersperse target trials and filler trials with alternate groups
  var trial_groups =
  {
    type: 'alternate-groups',
    groups: [[0,2],[1,3]],
    randomize_group_order: false // first trial will be an item from group 1.
    }
  */

  /* Procedure for target trials in the test block */
  var trial_procedure = {
    timeline: [polysemy_audiobutton],
    timeline_variables: test_stimuli,
    randomize_order: true // switch to 'sample:' when there are fillers
  };

/* 3. PAL Task: two train blocks */

  /* Create timeline variable of video and audio for all 18 pairs in two conditions. */
  var train_stimuli1 = [];
  for (i = 0; i < cond1.length/2; i++) {
    var vidName = cond1[i];
    var vidName = vidName.replace("videos/cond1_", "");
    var vidName = vidName.replace(".mov", "");
    var vidName = vidName.split("_");
    var vidPair = vidName[0];
    var vidObjectNumber = vidName[1];
    var vidObject = vidObjectNumber.slice(0, -1);
    var vidNumber = vidObjectNumber.substr(vidObjectNumber.length - 1);
    train_stimuli1[i] = {
      video: [cond1[i]], type: 1, icoamb: vidPair, obj: vidObject, num: vidNumber, block: 'train'}, + "\n";
    }

  /* Split stimuli into iconic and ambiguous conditions */
  // var popHalf = cond1.length/2;
  // var train_stimuli1 = [];
  // var train_stimuli2 = [];
  // for (i = 0; i < popHalf; i += 1) {
  //     var train_stimuli1[i] = trainStimuli[i];
  // };
  // for (j = 0, i = popHalf; i < cond1.length; i += 1, j += 1) {
  //     var train_stimuli2[i] = trainStimuli[i];
  // };

  /* Video-keyboard trial for PAL task */
  var pal_videokeyboard = {
      type: 'video-keyboard-response',
      sources: jsPsych.timelineVariable('video'),
      width: 640,
      data: {
        video: jsPsych.timelineVariable('video'),
        type: jsPsych.timelineVariable('type'),
        icoamb: jsPsych.timelineVariable('icoamb'),
        obj: jsPsych.timelineVariable('obj'),
        num: jsPsych.timelineVariable('num'),
        block: jsPsych.timelineVariable('block'),
        task: 'pal'
      }
  };

  /* Audio-button trial for PAL task */
  var pal_audiobutton = {
        type: 'audio-button-response',
        stimulus: 'audio/teachingaudio.mp3',
        choices: ['next'],
    };


  /* Procedure for target trials in the test block */
  var test_procedure1 = {
    timeline: [pal_audiobutton, pal_videokeyboard],
    timeline_variables: train_stimuli1,
    randomize_order: true
  };

/* 4: PAL Task: Free sort */
  // var sorting_stimuli = [];
  // for (var i = 1; i <= 12; i++) {
  //   sorting_stimuli.push("img/cell_img_" + i + ".jpg");
  // }
  //
  // var sort_trial = {
  //   type: 'free-sort',
  //   stimuli: sorting_stimuli,
  //   prompt: "<p>Click and drag the images below to sort them so that similar items are close together.</p>"
  // };

/******************************************************************************/
/* Timeline */

  /* Launch fullscreen mode. note: this plugin will NOT work for Safari */
  timeline.push({
    type: 'fullscreen',
    fullscreen_mode: true
  });

  /* Welcome page */
  timeline.push({
    type: 'html-keyboard-response',
    stimulus: 'Welcome to this experiment! Press the space bar to continue.'
  });

  /* Practice */
  timeline.push({
    type: 'html-keyboard-response',
    stimulus: 'Let\'s try some practice first.'
  });

  timeline.push(intro_procedure);

  timeline.push({
    type: 'html-keyboard-response',
    stimulus: 'Perfect! Let\'s keep going.'
  });

  timeline.push(trial_procedure);

  /* Transition page */
  timeline.push({
    type: 'html-keyboard-response',
    stimulus: 'Great job! Press the space bar to continue.'
  });

  timeline.push(test_procedure1);

/******************************************************************************/
/* Initialize */

  /* Paths to all stimuli for preloading because of timeline variables */
  var allImages = testDistractors.concat(testTargets);
  var allImages = allImages.concat(introImages);
  var allAudio = testAudio.concat(introAudio);
  var allAudio = allAudio.concat(palAudio);
  var allVideos = cond1.concat(cond2);

  jsPsych.init({
    timeline: timeline,
    preload_images: allImages,
    preload_audio: allAudio,
    preload_video: allVideos,
    default_iti: 100, // intertrial interval (ms)
    experiment_width: 750, // max experiment width
    use_webaudio: false, // load audio through HTML5 when running locally
    on_finish: function(){
      jsPsych.data.displayData(); // saved data
    }
    /* excludes browsers that don't have access to WebAudio API
    exclusions: {
      audio: true
    }
    */
  });

  </script>
</html>
